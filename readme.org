#+TITLE: My personal dotfiles configured using a single org file, using NixOS, home-manager and emacs
#+PROPERTY: header-args :tangle-mode (identity #o444)
#+STARTUP: overview
#+AUTHOR: Susan
#+EMAIL: susan@susan.lol

* Description
My personal dotfiles configured completely in org mode.
* flake.nix
Generate the flake.nix directly from org
#+begin_src nix :tangle ./flake.nix
  {
    description = "My personal nixos configuration";
  
    inputs = {
      nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  
      home-manager = {
        url = "github:nix-community/home-manager";
        inputs.nixpkgs.follows = "nixpkgs";
      };
    };
  
    outputs = inputs @ {self, nixpkgs, home-manager, ...} :
    {
      nixosConfigurations = (
        import ./hosts {
          inherit (nixpkgs) lib;
          inherit inputs nixpkgs home-manager;
        }
      );
    };
  }
#+end_src

* Hosts
General configurations that used on all hosts + folders for host specific
** default.nix
#+begin_src nix :tangle ./hosts/default.nix
  { lib, inputs, nixpkgs, home-manager, ... }:
  let
    system = "x86_64_linux";
  
    pkgs = import nixpkgs {
      inherit system;
      config.allowUnfree = true;
    };

    lib = nixpkgs.lib;
  in
  {
    framework = lib.nixosSystem {
      inherit system;
      modules = [
        ./framework
        ./configuration.nix
  
        home-manager.nixosModules.home-manager {
          home-manager.useUserPackages = true;

          home-manager.users.susan = {
            imports = [(import ./home.nix)] ++ [(import ./framework/home.nix)];
          };
        } 
      ];
    };
  } 
#+end_src
** configuration.nix
#+begin_src nix :tangle ./hosts/configuration.nix
  { config, lib, pkgs, ... }:
  {
    time.timeZone = "Europe/Bucharest";
  
    boot.kernelPackages = pkgs.linuxPackages_latest;

    security.polkit.enable = true;
    nixpkgs.config.allowUnfree = true;
  
    fonts.packages = with pkgs; [
     (nerdfonts.override { fonts = [ "FiraCode" ]; })
     font-awesome
    ];
  
    services = {
      udev.packages = [ pkgs.yubikey-personalization ];
      pcscd.enable = true;
      pipewire = { 
        enable = true;
        pulse.enable = true;
      }; 
    };
  
    users = {
      mutableUsers = false; 
      defaultUserShell = pkgs.fish;
      users.susan = {
        isNormalUser = true;
        extraGroups = [ "wheel" "video"];
        hashedPassword = "$6$vru/Kz/2RFnBeCXQ$FPDE/DET/P2pNfE2bpVsEdDCeMegmeMApE4l3m/2YR9t6qCSrdiTzqUr8aN1gnOTAcYXBQ30NUf3UtqxINmDL.";
      };
    };
  
    environment.systemPackages = with pkgs; [
    ];

    programs = {
      fish.enable = true;
    };
  
    nix.settings.experimental-features = [ "nix-command" "flakes" ];

    networking.networkmanager.enable = true;
  
    system = {
      autoUpgrade = {
        enable = true;
        dates = "02:00";
        persistent = true;
        flake = "github:susanthenerd/dotfiles";
        allowReboot = true;
        rebootWindow = {
          lower = "02:00";
          upper = "04:00";
        };
      }; 
      # This value determines the NixOS release from which the default
      # settings for stateful data, like file locations and database versions
      # on your system were taken. It's perfectly fine and recommended to leave
      # this value at the release version of the first install of this system.
      # Before changing this value read the documentation for this option
      # (e.g. man configuration.nix or on https://nixos.org/nixos/options.html).
      stateVersion = "23.05"; # Did you read the comment?
    }; 
  }
#+end_src
** home.nix
home-manager configs
#+begin_src nix :tangle ./hosts/home.nix
  { config, lib, pkgs, ... }:
  { 
    imports =
    [(import ../modules/programs/exa)]
    ++ [(import ../modules/programs/fish)]
    ++ [(import ../modules/programs/git)]
    ++ [(import ../modules/programs/starship)];
  
    home = {
      username = "susan";
      homeDirectory = "/home/susan";
  
      packages = with pkgs; [
        prismlauncher
        firefox
        signal-desktop
        yubioath-flutter
        # skypeforlinux
        pavucontrol
        emacs29-pgtk
        pinentry-curses
        fuzzel
      ];
      # pointerCursor = {                         # This will set cursor system-wide so applications can not choose their own
      #  gtk.enable = true;
      #  #name = "Dracula-cursors";
      #  name = "Catppuccin-Mocha-Dark-Cursors";
      #  #package = pkgs.dracula-theme;
      #  package = pkgs.catppuccin-cursors.mochaDark;
      #  size = 16;
      # };
      stateVersion = "23.05";
    };

    programs = {
      home-manager.enable = true;
      fish.enable = true;
      neovim.enable = true;
    };
  
    #gtk = {                                     # Theming
    #  enable = true;
    #  theme = {
    #    name = "Gruvbox-Dark";
    #    package = pkgs.gruvbox-dark-gtk;
    #  };
    #  iconTheme = {
    #    name = "Papirus-Dark";
    #    package = pkgs.papirus-icon-theme;
    #  };
    #  font = {
    #    name = "FiraCode Nerd Font Mono Medium";
    #  };                                        # Cursor is declared under home.pointerCursor 
    #};
  }
#+END_src
** Framework Laptop
Specific configs for my Framework Laptop
Specs of the Framework
i7-1280P 6P 8E 20T 4.7Ghz
64GB DDR4 3200Mhz
Segate Firecuda 530 2TB Nvme GEN 4x4

*** default.nix
#+begin_src nix :tangle ./hosts/framework/default.nix
  { config, pkgs, lib, ... }:
  {
    security.pam.services = {
      login.u2fAuth = true;
      sudo.u2fAuth = true;
    };
  
    imports = [(import ./hardware-configuration.nix)] ++ [(../../modules/services/syncthing)];
  
    programs = {
      light.enable = true;
    };

    networking.hostName = "framework";
  
    services = {
      #tlp.enable = true;                      # TLP and auto-cpufreq for power management
      auto-cpufreq.enable = true;
      blueman.enable = true;
    };
    xdg.portal = {
      enable = true;
      wlr.enable = true;
    };
  }
#+end_src
*** hardware-configuration.nix
The only special thing here is that I have here configured the file systems
#+begin_src nix :tangle ./hosts/framework/hardware-configuration.nix
  { config, lib, pkgs, modulesPath, ... }:
  {

    imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

    fileSystems = {
      "/" ={ 
        device = "/dev/disk/by-uuid/b183e5d3-8679-4e45-88e6-bc1393323dfd";
        fsType = "btrfs";
      };
      "/boot" ={ 
        device = "/dev/disk/by-uuid/9829-2BBA";
        fsType = "vfat";
      };
    };
  
    boot = {
      initrd = {
        availableKernelModules = [ "xhci_pci" "thunderbolt" "nvme" "usb_storage" "usbhid" "sd_mod" ];
        kernelModules = [ "dm-snapshot" ];
        luks.devices."luks" = { 
          device = "/dev/disk/by-uuid/6c40ab71-86cd-40ff-82f6-0936ad7eb61d";
          preLVM = true;
        };
      };
      kernelModules = [ "kvm-intel" ];
      extraModulePackages = [ ];
      loader = {
        systemd-boot.enable = true;
        efi.canTouchEfiVariables = true;
      };
    };
  
    swapDevices =
      [ { device = "/dev/disk/by-uuid/9a231275-fc03-40c1-8c7b-a14f1592f185"; }
      ];

    networking.useDHCP = lib.mkDefault true;

    nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
    powerManagement.cpuFreqGovernor = lib.mkDefault "powersave";
    hardware = {
      opengl.enable = true;
      pulseaudio.enable = false;
      cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
    };
  }
#+end_src
*** home.nix
Specific home-manager configs for my framework
#+begin_src nix :tangle ./hosts/framework/home.nix
  { config, lib, pkgs, ... }:
  {
    imports = [(import ../../modules/desktop/sway)]
    ++ [(import ../../modules/programs/foot)]
    ++ [(import ../../modules/programs/i3status-rust)];
    programs = {
      obs-studio.enable = true;
    };
    xdg.enable = true;
  }
#+end_src
* Modules
** Desktop
*** Sway
#+begin_src nix :tangle ./modules/desktop/sway/default.nix
  {config, lib, pkgs, ... }:
  {
    wayland.windowManager.sway = {
      enable = true;
      config = rec {
        modifier = "Mod4";
        terminal = "foot";
        startup = [
          # Launch Firefox on start
          {command = "firefox";}
        ];
        fonts = {                                                                                                                                                                     
          names = [ "FiraCode Nerd Font Mono" "FontAwesome"];
          style = "Regular";
          size = 11.0;
        };    

        bars = [
          {
            fonts = {
              names = [ "FiraCode Nerd Font Mono" "FontAwesome"];
              style = "Regular";
              size = 11.0;
            };
            position = "bottom";
            statusCommand = "i3status-rs ~/.config/i3status-rust/config-default.toml";
            # colors={
            #  separator = "#666666";
            #  background = "#222222";
            #  statusline = "#dddddd";
            #  focusedWorkspace = {
            #    background = "#0088CC";
            #    border = "#0088CC";
            #    text = "#ffffff";
            #  };
            #  activeWorkspace = {
            #    background = "#333333";
            #    border = "#333333";
            #    text = "#ffffff";
            #  };
            #  inactiveWorkspace = {
            #   background = "#333333";
            #   border = "#333333";
            #   text = "#888888";
            #  };
            #  urgentWorkspace = {
            #    background = "#2f343a";
            #    border = "#900000";
            #    text = "#ffffff";
            #  };
            #};
          }
        ];
        gaps = {
          outer = 4;
          inner = 4;
          smartBorders = "on";
        };
        keybindings = {
          #Launch stuff
          "${modifier}+Return" = "exec ${terminal}";
          "${modifier}+Shift+b" = "exec firefox";
          "${modifier}+Shift+Return" = "exec fuzzel";
  
          # Windows
          "${modifier}+Shift+c" = "kill";

          # Layouts
          "${modifier}+b" = "splith";
          "${modifier}+v" = "splitv";

          # Switch the current container between different layout styles
          "${modifier}+s" = "layout stacking";
          "${modifier}+w" = "layout tabbed";
          "${modifier}+e" = "layout toggle split";

          "${modifier}+f" = "fullscreen";

          # Toggle the current focus between tiling and floating mode
          "${modifier}+Shift+space" = "floating toggle";

          # Swap focus between the tiling area and the floating area
          "${modifier}+space" = "focus mode_toggle";

          # Move focus to the parent container
          "${modifier}+a" = "focus parent";
  
          # Workspaces
          "${modifier}+1" = "workspace number 1";
          "${modifier}+2" = "workspace number 2";
          "${modifier}+3" = "workspace number 3";
          "${modifier}+4" = "workspace number 4";
          "${modifier}+5" = "workspace number 5";
          "${modifier}+6" = "workspace number 6";
          "${modifier}+7" = "workspace number 7";
          "${modifier}+8" = "workspace number 8";
          "${modifier}+9" = "workspace number 9";

          "${modifier}+Shift+1" = "move container to workspace number 1";                                                               
      	  "${modifier}+Shift+2" = "move container to workspace number 2";                                                               
      	  "${modifier}+Shift+3" = "move container to workspace number 3";                                                               
   	  "${modifier}+Shift+4" = "move container to workspace number 4";                                                               
      	  "${modifier}+Shift+5" = "move container to workspace number 5";                                                               
      	  "${modifier}+Shift+6" = "move container to workspace number 6";                                                               
      	  "${modifier}+Shift+7" = "move container to workspace number 7";                                                               
      	  "${modifier}+Shift+8" = "move container to workspace number 8";                                                               
      	  "${modifier}+Shift+9" = "move container to workspace number 9";

          # Resize
          "${modifier}+r" = "mode resize";
  
          # Other keybindings
          "${modifier}+Shift+r" = "reload";
          "${modifier}+Shift+e" = "exec swaynag -t warning -m 'You pressed the exit shortcut. Do you really want to exit sway? This will end your Wayland session.' -b 'Yes, exit sway' 'swaymsg exit'";
        };
        modes = {
          resize = {
            "Down" = "resize grow height 10 px";
            "Escape" = "mode default";
            "Left" = "resize shrink width 10 px";
            "Return" = "mode default";
            "Right" = "resize grow width 10 px";
            "Up" = "resize shrink height 10 px";
            "h" = "resize shrink width 10 px";
            "j" = "resize grow height 10 px";
            "k" = "resize shrink height 10 px";
            "l" = "resize grow width 10 px";
          };
        };
  
        output = {
          eDP-1 = {
            scale = "1";
	  };
	};
      };
    };
  }
#+end_src
** Programs
*** Exa
#+begin_src nix :tangle ./modules/programs/exa/default.nix
  {config, lib, pkgs, ... }:
  {
    programs.exa = {
      enable = true;
      git = true;
      icons = true;
      enableAliases = true;
    };
  }
#+end_src
*** Fish
#+begin_src nix :tangle ./modules/programs/fish/default.nix
  {config, lib, pkgs, ...}:
  {
    programs.fish = {
      enable = true;
      shellAliases = {
        "rebuild" = "sudo nixos-rebuild switch --flake .";
        "flake-check" = "nix flake check";
      };
    };
  }
#+end_src
*** Foot
#+begin_src nix :tangle ./modules/programs/foot/default.nix
  {config, lib, pkgs, ...}:
  {
    programs.foot = {
      enable = true;
      settings = {
        main = {
          font = "FiraCode Nerd Font Mono:size=14";
        };
        colors = {
          # Gruvbox Dark
          background = "282828";
          foreground = "ebdbb2";
          regular0 = "282828";
          regular1 = "cc241d";
          regular2 = "98971a";
          regular3 = "d79921";
          regular4 = "458588";
          regular5 = "b16286";
          regular6 = "689d6a";
          regular7 = "a89984";
          bright0 = "928374";
          bright1 = "fb4934";
          bright2 = "b8bb26";
          bright3 = "fabd2f";
          bright4 = "83a598";
          bright5 = "d3869b";
          bright6 = "8ec07c";
          bright7 = "ebdbb2";
        };
      };
    };
  }
#+end_src
*** Git
#+begin_src nix :tangle ./modules/programs/git/default.nix
  {config, lib, pkgs, ... }:
  {
    programs.git = {
      enable = true;
      userName = "Susan";
      userEmail = "susan@susan.lol";
    };
  }
#+end_src
*** i3Status-rust
#+begin_src nix :tangle ./modules/programs/i3status-rust/default.nix
  {config, lib, pkgs, ... }:
  {
    programs.i3status-rust = {
      enable = true;
      bars = {
        default = {
          theme = "gruvbox-dark";
          icons = "awesome6";
          blocks = [
            {
              block = "memory";
              format = " $icon $mem_used_percents ";
              format_alt = " $icon SWAP $swap_used_percents ";
            }
            {
              block = "cpu";
              interval = 1;
            }
            {
              block = "load";
              format = " $icon $1m ";
              interval = 1;
            }
            {
              block = "sound";
            }
            {
              block = "backlight";
            }
            {
              block = "time";
              format = " $timestamp.datetime(f:'%a %d/%m %R') ";
              interval = 60;
            }
          ];
        };
      };
    };
  }
#+end_src
*** Starship
#+begin_src nix :tangle ./modules/programs/starship/default.nix
  {config, lib, pkgs, ... }:
  {
    programs.starship = {
      enable = true;
      # Configuration written to ~/.config/starship.toml
      settings = {
        # add_newline = false;
  
        # character = {
        #   success_symbol = "[➜](bold green)";
        #   error_symbol = "[➜](bold red)";
        # };
  
        # package.disabled = true;
      };
    };
  }
#+end_src
** Services
All services configured on my laptop and servers
*** Syncthing
File sync to my phone
#+begin_src nix :tangle ./modules/services/syncthing/default.nix
  {config, pkgs, lib, ... }:
  { 
    services.syncthing = {
      enable = true;
      user = "susan";
      dataDir = "/home/susan/phone/";
      configDir = "/home/susan/.config/syncthing"; # I don't have any special configurations, but I'm letting this option here in case I forget about it 
    };
  }
#+end_src
* Github Actions
** automate daily version bump
#+begin_src yaml :tangle ./.github/workflows/auto-version-bump.yaml
  name: Daily Nix Flake Version Bump

  on:
    schedule:
      - cron:  '0 0 * * *'

  jobs:
    flake_update:
      runs-on: ubuntu-latest

      steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Nix
        uses: cachix/install-nix-action@v16

      - name: Update Flake
        run: |
          nix flake update
          if nix flake check; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add flake.lock
            git commit -m "automated daily version bump"
            git push
          fi
#+end_src
** automated nix flake check on push
#+begin_src yaml :tangle ./.github/workflows/auto-commit-check.yaml
  name: Nix Flake Check On Commit
  
  on:
    push:
      branches:
        - '**'
  
  jobs:
    flake_check:
      runs-on: ubuntu-latest
  
      steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Nix
        uses: cachix/install-nix-action@v22

      - name: Nix Flake Check
        run: nix flake check
#+end_src
